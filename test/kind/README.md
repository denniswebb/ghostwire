# KIND Integration Testing

This directory provides a repeatable workflow for exercising the `ghostwire init` command against a live Kubernetes API using a local [KIND](https://kind.sigs.k8s.io/) cluster. It complements the unit tests in `internal/` by validating service discovery, DNAT rule wiring, and generated audit artefacts end to end.

## Prerequisites

Install the following tools before running the scripts:

| Tool | Purpose | Install |
| ---- | ------- | ------- |
| [KIND](https://kind.sigs.k8s.io/) | Local Kubernetes cluster in Docker | `brew install kind` |
| [kubectl](https://kubernetes.io/docs/tasks/tools/) | Kubernetes CLI | `brew install kubernetes-cli` |
| [Docker](https://docs.docker.com/get-docker/) | Image build/runtime for KIND nodes | Desktop app or `brew install --cask docker` |
| [mise](https://mise.jdx.dev/) (optional) | Project task runner | `brew install mise` |

> KIND requires Docker Desktop (or another container runtime) to be running.

## Quick Start

```sh
# 1. Create the cluster
./test/kind/setup-cluster.sh

# 2. Build the CLI, create a container image, and push it to KIND
./test/kind/load-image.sh

# 3. Deploy namespace, RBAC, and service fixtures
./test/kind/deploy-test.sh

# 4. (Optional) Deploy the ghostwire init pod immediately
./test/kind/deploy-test.sh --with-pod

# 5. Validate generated artefacts
./test/kind/validate-dnatmap.sh
./test/kind/validate-iptables.sh
```

Finish with `./test/kind/teardown-cluster.sh` to reclaim resources.

## Directory Layout

| Path | Description |
| ---- | ----------- |
| `cluster-config.yaml` | KIND configuration for a single control-plane node with port 8081 exposed for watcher metrics. |
| `setup-cluster.sh` / `teardown-cluster.sh` | Scripts to create and delete the cluster. |
| `load-image.sh` | Builds the ghostwire binary, packages it into a Docker image, and loads it into the KIND node. |
| `deploy-test.sh` | Applies namespace/RBAC/service fixtures and optionally launches the init test pod. |
| `validate-dnatmap.sh` | Copies `/shared/dnat.map` from the init pod and checks expected mappings. |
| `validate-iptables.sh` | Executes `iptables -t nat -S CANARY_DNAT` inside the KIND node to verify DNAT rules. |
| `manifests/` | Kubernetes manifests used by the integration environment (namespace, services, RBAC, and test pod). |

## Manual Testing Procedure

1. **Cluster setup**
   ```sh
   ./test/kind/setup-cluster.sh
   kind get clusters
   kubectl cluster-info --context kind-ghostwire-test
   ```
2. **Apply fixtures**
   ```sh
   ./test/kind/deploy-test.sh
   kubectl --context kind-ghostwire-test get svc -n ghostwire-test
   ```
3. **Build and load image**
   ```sh
   ./test/kind/load-image.sh
   kind load docker-image ghostwire:local --name ghostwire-test  # no-op if already run
   ```
4. **Run the init pod**
   ```sh
   ./test/kind/deploy-test.sh --with-pod
   kubectl --context kind-ghostwire-test logs -n ghostwire-test ghostwire-init-test
   ```
5. **Inspect artefacts**
   ```sh
   kubectl --context kind-ghostwire-test exec -n ghostwire-test ghostwire-init-test -- cat /shared/dnat.map
   docker exec ghostwire-test-control-plane iptables -t nat -L CANARY_DNAT -n -v
   ```

## Validation Scripts

- `validate-dnatmap.sh`: copies `/shared/dnat.map` from the init pod, prints its contents, and checks for expected entries (orders, payment, api-v2) while ensuring services without preview variants are absent.
- `validate-iptables.sh`: retrieves active and preview cluster IPs via `kubectl`, then verifies that the KIND node's `CANARY_DNAT` chain contains matching DNAT rules and the metadata service exclusion.

Both scripts exit non-zero on failure so they can be chained into automated smoke tests.

## Expected Results

`/shared/dnat.map` should resemble:

```
# DNAT mappings generated by ghostwire-init
# Format: service:port/protocol active_ip -> preview_ip
orders:80/TCP 10.96.x.y -> 10.96.x.z
orders:443/TCP 10.96.x.y -> 10.96.x.z
payment:8080/TCP 10.96.x.a -> 10.96.x.b
api-v2:8080/TCP ...
api-v2:8443/TCP ...
api-v2:9090/TCP ...
```

`iptables -t nat -S CANARY_DNAT` should include:

- `-A CANARY_DNAT -d 169.254.169.254/32 -j RETURN` (IMDS exclusion).
- One DNAT rule per mapping listed above.

## Troubleshooting

- **`kind: command not found`** – Install KIND and ensure Docker Desktop is running.
- **Cluster already exists** – `setup-cluster.sh` will prompt to recreate. Answer `y` to rebuild from scratch.
- **`load-image.sh` fails** – Ensure Docker is running and you have built the binary (`mise run build`).
- **Pod stuck in `ImagePullBackOff`** – Re-run `load-image.sh`; KIND nodes do not pull from Docker Desktop automatically.
- **`validate-dnatmap.sh` copy failure** – The init pod must still be present. Re-run `deploy-test.sh --with-pod` to recreate it.
- **`validate-iptables.sh` missing rules** – Confirm the init pod completed successfully and review pod logs for service discovery warnings.

## Cleanup

```sh
./test/kind/teardown-cluster.sh
rm -f ghostwire
```

## Next Steps

This harness covers the init container path. Future work will extend it to exercise the watcher sidecar, ensuring the `CANARY_DNAT` chain is activated when preview mode is enabled.
